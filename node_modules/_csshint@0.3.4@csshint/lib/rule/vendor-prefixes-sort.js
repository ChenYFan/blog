'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.check = undefined;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _util = require('../util');

var _prefixes = require('../prefixes');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @file vendor-prefixes-sort 的检测逻辑
 *       046: [强制] 带私有前缀的属性由长到短排列，按冒号位置对齐。
 * @author ielgnaw(wuji0223@gmail.com)
 */

var prefixList = (0, _prefixes.getPrefixList)();

/**
 * 当前文件所代表的规则名称
 *
 * @const
 * @type {string}
 */
var RULENAME = 'vendor-prefixes-sort';

/**
 * 错误信息，带私有前缀的属性按冒号位置对齐
 *
 * @const
 * @type {string}
 */
var COLON_MSG = 'Property with private prefix should be according to the colon position alignment';

/**
 * 错误信息，带私有前缀的属性由长到短排列
 *
 * @const
 * @type {string}
 */
var SHORT_MSG = 'Property with private prefix from long to short arrangement';

var countMap = {};

/**
 * 判断是否是合法的 css 属性名称
 *
 * @param {Object} decl postcss 节点对象
 *
 * @return {boolean} 结果
 */
var isValidVendorProp = function isValidVendorProp(decl) {
    var prop = decl.prop;
    var standardProperty = prop.replace(/^\-(webkit|moz|ms|o)\-/g, '');
    // 标准模式在 prefixList 中，那么如果 propertyName 不在 prefixList 中
    // 即这个属性用错了，例如 -o-animation
    if (prefixList.indexOf(standardProperty) > -1) {
        if (prefixList.indexOf(prop) <= -1) {
            return false;
        }
        // 按选择器分组
        var selector = decl.parent.selector;
        var parent = decl.parent;

        while (parent.type !== 'root') {
            parent = parent.parent || {};
            if (parent.type === 'atrule') {
                selector += '-in-atrule-' + (parent.name || '');
            }
        }

        if (!countMap[selector]) {
            countMap[selector] = {};
        }
        var tmp = countMap[selector];

        if (!tmp[standardProperty]) {
            tmp[standardProperty] = [];
        }
        tmp[standardProperty].push(decl);
    }
    return true;
};

/**
 * 具体的检测逻辑
 *
 * @param {Object} opts 参数
 * @param {*} opts.ruleVal 当前规则具体配置的值
 * @param {string} opts.fileContent 文件内容
 * @param {string} opts.filePath 文件路径
 */
var check = exports.check = _postcss2.default.plugin(RULENAME, function (opts) {
    return function (css, result) {
        /* jshint maxstatements: 31, maxcomplexity: 11 */

        if (!opts.ruleVal) {
            return;
        }

        countMap = {};

        css.walkDecls(function (decl) {
            if (global.CSSHINT_INVALID_ALL_COUNT >= opts.maxError) {
                return;
            }
            if (!isValidVendorProp(decl, result)) {
                return;
            }
        });

        /* eslint-disable fecs-use-for-of, fecs-valid-map-set */
        for (var selector in countMap) {
            if (!countMap.hasOwnProperty(selector)) {
                continue;
            }

            for (var j in countMap[selector]) {
                if (!countMap[selector].hasOwnProperty(j)) {
                    continue;
                }
                var maxLength = 0;
                var firstColonIndex = 0;
                for (var i = 0, len = countMap[selector][j].length; i < len; i++) {
                    var item = countMap[selector][j][i];
                    var prop = item.prop;

                    if (countMap[selector][prop.replace(/^\-(webkit|moz|ms|o)\-/g, '')].length <= 1) {
                        continue;
                    }

                    var source = item.source;
                    var line = source.start.line;
                    var lineContent = (0, _util.getLineContent)(line, source.input.css);

                    var length = prop.length;

                    // 第一个
                    if (maxLength === 0) {
                        maxLength = length;
                        firstColonIndex = lineContent.indexOf(':') + 1;
                    }

                    var curColonIndex = lineContent.indexOf(':') + 1;
                    if (firstColonIndex !== curColonIndex) {
                        result.warn(RULENAME, {
                            node: item,
                            ruleName: RULENAME,
                            line: line,
                            message: '`' + lineContent + '` ' + COLON_MSG,
                            colorMessage: '`' + _chalk2.default.magenta(lineContent) + '` ' + _chalk2.default.grey(COLON_MSG)
                        });

                        global.CSSHINT_INVALID_ALL_COUNT++;
                    }

                    if (maxLength < length) {
                        result.warn(RULENAME, {
                            node: item,
                            ruleName: RULENAME,
                            line: line,
                            message: '`' + lineContent + '` ' + SHORT_MSG,
                            colorMessage: '`' + _chalk2.default.magenta(lineContent) + '` ' + _chalk2.default.grey(SHORT_MSG)
                        });

                        global.CSSHINT_INVALID_ALL_COUNT++;
                    }
                }
            }
        }
        /* eslint-enable fecs-use-for-of, fecs-valid-map-set */
    };
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlL3ZlbmRvci1wcmVmaXhlcy1zb3J0LmpzIl0sIm5hbWVzIjpbInByZWZpeExpc3QiLCJSVUxFTkFNRSIsIkNPTE9OX01TRyIsIlNIT1JUX01TRyIsImNvdW50TWFwIiwiaXNWYWxpZFZlbmRvclByb3AiLCJwcm9wIiwiZGVjbCIsInN0YW5kYXJkUHJvcGVydHkiLCJyZXBsYWNlIiwiaW5kZXhPZiIsInNlbGVjdG9yIiwicGFyZW50IiwidHlwZSIsIm5hbWUiLCJ0bXAiLCJwdXNoIiwiY2hlY2siLCJwb3N0Y3NzIiwicGx1Z2luIiwiY3NzIiwicmVzdWx0Iiwib3B0cyIsInJ1bGVWYWwiLCJ3YWxrRGVjbHMiLCJnbG9iYWwiLCJDU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UIiwibWF4RXJyb3IiLCJoYXNPd25Qcm9wZXJ0eSIsImoiLCJtYXhMZW5ndGgiLCJmaXJzdENvbG9uSW5kZXgiLCJpIiwibGVuIiwibGVuZ3RoIiwiaXRlbSIsInNvdXJjZSIsImxpbmUiLCJzdGFydCIsImxpbmVDb250ZW50IiwiaW5wdXQiLCJjdXJDb2xvbkluZGV4Iiwid2FybiIsIm5vZGUiLCJydWxlTmFtZSIsIm1lc3NhZ2UiLCJjb2xvck1lc3NhZ2UiLCJjaGFsayIsIm1hZ2VudGEiLCJncmV5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBTUE7Ozs7QUFDQTs7OztBQUVBOztBQUNBOzs7O0FBVkE7Ozs7OztBQVlBLElBQU1BLGFBQWEsOEJBQW5COztBQUVBOzs7Ozs7QUFNQSxJQUFNQyxXQUFXLHNCQUFqQjs7QUFFQTs7Ozs7O0FBTUEsSUFBTUMsWUFBWSxrRkFBbEI7O0FBRUE7Ozs7OztBQU1BLElBQU1DLFlBQVksNkRBQWxCOztBQUVBLElBQUlDLFdBQVcsRUFBZjs7QUFFQTs7Ozs7OztBQU9BLElBQU1DLG9CQUFvQixTQUFwQkEsaUJBQW9CLE9BQVE7QUFDOUIsUUFBTUMsT0FBT0MsS0FBS0QsSUFBbEI7QUFDQSxRQUFNRSxtQkFBbUJGLEtBQUtHLE9B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QGZpbGUgdmVuZG9yLXByZWZpeGVzLXNvcnQg55qE5qOA5rWL6YC76L6RXG4gKiAgICAgICAwNDY6IFvlvLrliLZdIOW4puengeacieWJjee8gOeahOWxnuaAp+eUsemVv+WIsOefreaOkuWIl++8jOaMieWGkuWPt+S9jee9ruWvuem9kOOAglxuICogQGF1dGhvciBpZWxnbmF3KHd1amkwMjIzQGdtYWlsLmNvbSlcbiAqL1xuXG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0IHBvc3Rjc3MgZnJvbSAncG9zdGNzcyc7XG5cbmltcG9ydCB7Z2V0TGluZUNvbnRlbnR9IGZyb20gJy4uL3V0aWwnO1xuaW1wb3J0IHtnZXRQcmVmaXhMaXN0fSBmcm9tICcuLi9wcmVmaXhlcyc7XG5cbmNvbnN0IHByZWZpeExpc3QgPSBnZXRQcmVmaXhMaXN0KCk7XG5cbi8qKlxuICog5b2T5YmN5paH5Lu25omA5Luj6KGo55qE6KeE5YiZ5ZCN56ewXG4gKlxuICogQGNvbnN0XG4gKiBAdHlwZSB7c3RyaW5nfVxuICovXG5jb25zdCBSVUxFTkFNRSA9ICd2ZW5kb3ItcHJlZml4ZXMtc29ydCc7XG5cbi8qKlxuICog6ZSZ6K+v5L+h5oGv77yM5bim56eB5pyJ5YmN57yA55qE5bGe5oCn5oyJ5YaS5Y+35L2N572u5a+56b2QXG4gKlxuICogQGNvbnN0XG4gKiBAdHlwZSB7c3RyaW5nfVxuICovXG5jb25zdCBDT0xPTl9NU0cgPSAnUHJvcGVydHkgd2l0aCBwcml2YXRlIHByZWZpeCBzaG91bGQgYmUgYWNjb3JkaW5nIHRvIHRoZSBjb2xvbiBwb3NpdGlvbiBhbGlnbm1lbnQnO1xuXG4vKipcbiAqIOmUmeivr+S/oeaBr++8jOW4puengeacieWJjee8gOeahOWxnuaAp+eUsemVv+WIsOefreaOkuWIl1xuICpcbiAqIEBjb25zdFxuICogQHR5cGUge3N0cmluZ31cbiAqL1xuY29uc3QgU0hPUlRfTVNHID0gJ1Byb3BlcnR5IHdpdGggcHJpdmF0ZSBwcmVmaXggZnJvbSBsb25nIHRvIHNob3J0IGFycmFuZ2VtZW50JztcblxubGV0IGNvdW50TWFwID0ge307XG5cbi8qKlxuICog5Yik5pat5piv5ZCm5piv5ZCI5rOV55qEIGNzcyDlsZ7mgKflkI3np7BcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gZGVjbCBwb3N0Y3NzIOiKgueCueWvueixoVxuICpcbiAqIEByZXR1cm4ge2Jvb2xlYW59IOe7k+aenFxuICovXG5jb25zdCBpc1ZhbGlkVmVuZG9yUHJvcCA9IGRlY2wgPT4ge1xuICAgIGNvbnN0IHByb3AgPSBkZWNsLnByb3A7XG4gICAgY29uc3Qgc3RhbmRhcmRQcm9wZXJ0eSA9IHByb3AucmVwbGFjZSgvXlxcLSh3ZWJraXR8bW96fG1zfG8pXFwtL2csICcnKTtcbiAgICAvLyDmoIflh4bmqKHlvI/lnKggcHJlZml4TGlzdCDkuK3vvIzpgqPkuYjlpoLmnpwgcHJvcGVydHlOYW1lIOS4jeWcqCBwcmVmaXhMaXN0IOS4rVxuICAgIC8vIOWNs+i/meS4quWxnuaAp+eUqOmUmeS6hu+8jOS+i+WmgiAtby1hbmltYXRpb25cbiAgICBpZiAocHJlZml4TGlzdC5pbmRleE9mKHN0YW5kYXJkUHJvcGVydHkpID4gLTEpIHtcbiAgICAgICAgaWYgKHByZWZpeExpc3QuaW5kZXhPZihwcm9wKSA8PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIC8vIOaMiemAieaLqeWZqOWIhue7hFxuICAgICAgICBsZXQgc2VsZWN0b3IgPSBkZWNsLnBhcmVudC5zZWxlY3RvcjtcbiAgICAgICAgbGV0IHBhcmVudCA9IGRlY2wucGFyZW50O1xuXG4gICAgICAgIHdoaWxlIChwYXJlbnQudHlwZSAhPT0gJ3Jvb3QnKSB7XG4gICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50IHx8IHt9O1xuICAgICAgICAgICAgaWYgKHBhcmVudC50eXBlID09PSAnYXRydWxlJykge1xuICAgICAgICAgICAgICAgIHNlbGVjdG9yICs9ICctaW4tYXRydWxlLScgKyAocGFyZW50Lm5hbWUgfHwgJycpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFjb3VudE1hcFtzZWxlY3Rvcl0pIHtcbiAgICAgICAgICAgIGNvdW50TWFwW3NlbGVjdG9yXSA9IHt9O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHRtcCA9IGNvdW50TWFwW3NlbGVjdG9yXTtcblxuICAgICAgICBpZiAoIXRtcFtzdGFuZGFyZFByb3BlcnR5XSkge1xuICAgICAgICAgICAgdG1wW3N0YW5kYXJkUHJvcGVydHldID0gW107XG4gICAgICAgIH1cbiAgICAgICAgdG1wW3N0YW5kYXJkUHJvcGVydHldLnB1c2goZGVjbCk7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xufTtcblxuLyoqXG4gKiDlhbfkvZPnmoTmo4DmtYvpgLvovpFcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0cyDlj4LmlbBcbiAqIEBwYXJhbSB7Kn0gb3B0cy5ydWxlVmFsIOW9k+WJjeinhOWImeWFt+S9k+mFjee9rueahOWAvFxuICogQHBhcmFtIHtzdHJpbmd9IG9wdHMuZmlsZUNvbnRlbnQg5paH5Lu25YaF5a65XG4gKiBAcGFyYW0ge3N0cmluZ30gb3B0cy5maWxlUGF0aCDmlofku7bot6/lvoRcbiAqL1xuZXhwb3J0IGNvbnN0IGNoZWNrID0gcG9zdGNzcy5wbHVnaW4oUlVMRU5BTUUsIG9wdHMgPT5cbiAgICAoY3NzLCByZXN1bHQpID0+IHtcbiAgICAgICAgLyoganNoaW50IG1heHN0YXRlbWVudHM6IDMxLCBtYXhjb21wbGV4aXR5OiAxMSAqL1xuXG4gICAgICAgIGlmICghb3B0cy5ydWxlVmFsKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb3VudE1hcCA9IHt9O1xuXG4gICAgICAgIGNzcy53YWxrRGVjbHMoZGVjbCA9PiB7XG4gICAgICAgICAgICBpZiAoZ2xvYmFsLkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQgPj0gb3B0cy5tYXhFcnJvcikge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghaXNWYWxpZFZlbmRvclByb3AoZGVjbCwgcmVzdWx0KSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLyogZXNsaW50LWRpc2FibGUgZmVjcy11c2UtZm9yLW9mLCBmZWNzLXZhbGlkLW1hcC1zZXQgKi9cbiAgICAgICAgZm9yIChsZXQgc2VsZWN0b3IgaW4gY291bnRNYXApIHtcbiAgICAgICAgICAgIGlmICghY291bnRNYXAuaGFzT3duUHJvcGVydHkoc2VsZWN0b3IpKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZvciAobGV0IGogaW4gY291bnRNYXBbc2VsZWN0b3JdKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFjb3VudE1hcFtzZWxlY3Rvcl0uaGFzT3duUHJvcGVydHkoaikpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxldCBtYXhMZW5ndGggPSAwO1xuICAgICAgICAgICAgICAgIGxldCBmaXJzdENvbG9uSW5kZXggPSAwO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBjb3VudE1hcFtzZWxlY3Rvcl1bal0ubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IGNvdW50TWFwW3NlbGVjdG9yXVtqXVtpXTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvcCA9IGl0ZW0ucHJvcDtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoY291bnRNYXBbc2VsZWN0b3JdW3Byb3AucmVwbGFjZSgvXlxcLSh3ZWJraXR8bW96fG1zfG8pXFwtL2csICcnKV0ubGVuZ3RoIDw9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gaXRlbS5zb3VyY2U7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmUgPSBzb3VyY2Uuc3RhcnQubGluZTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGluZUNvbnRlbnQgPSBnZXRMaW5lQ29udGVudChsaW5lLCBzb3VyY2UuaW5wdXQuY3NzKTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCBsZW5ndGggPSBwcm9wLmxlbmd0aDtcblxuICAgICAgICAgICAgICAgICAgICAvLyDnrKzkuIDkuKpcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1heExlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWF4TGVuZ3RoID0gbGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RDb2xvbkluZGV4ID0gbGluZUNvbnRlbnQuaW5kZXhPZignOicpICsgMTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1ckNvbG9uSW5kZXggPSBsaW5lQ29udGVudC5pbmRleE9mKCc6JykgKyAxO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZmlyc3RDb2xvbkluZGV4ICE9PSBjdXJDb2xvbkluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQud2FybihSVUxFTkFNRSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6IGl0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVsZU5hbWU6IFJVTEVOQU1FLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IGxpbmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogJ2AnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgbGluZUNvbnRlbnRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAnYCAnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgQ09MT05fTVNHLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yTWVzc2FnZTogJ2AnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgY2hhbGsubWFnZW50YShsaW5lQ29udGVudClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAnYCAnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgY2hhbGsuZ3JleShDT0xPTl9NU0cpXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsLkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQrKztcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChtYXhMZW5ndGggPCBsZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC53YXJuKFJVTEVOQU1FLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogaXRlbSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBydWxlTmFtZTogUlVMRU5BTUUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZTogbGluZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnYCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBsaW5lQ29udGVudFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArICdgICdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBTSE9SVF9NU0csXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JNZXNzYWdlOiAnYCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBjaGFsay5tYWdlbnRhKGxpbmVDb250ZW50KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArICdgICdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBjaGFsay5ncmV5KFNIT1JUX01TRylcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWwuQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCsrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8qIGVzbGludC1lbmFibGUgZmVjcy11c2UtZm9yLW9mLCBmZWNzLXZhbGlkLW1hcC1zZXQgKi9cbiAgICB9XG4pO1xuIl19